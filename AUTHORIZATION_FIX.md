# Authorization Kind Mismatch Fix

## Problem
When attempting to sign transactions with Auro Wallet, users encountered the following error:

```
Couldn't send zkApp command: (invalid ("Authorization kind does not match the authorization" ((expected Proof) (got None_given))))
```

## Root Cause Analysis

### The Issue
The error occurred because we were using the `registerDID` method which requires both:
1. A `Signature` parameter (explicit signature from the user)
2. A `Proof` authorization (ZK proof generated by wallet)

When sending an unproved transaction to Auro Wallet:
1. Transaction was built with a manually created signature
2. Transaction was sent to wallet WITHOUT proof (`None_given`)
3. Wallet attempted to add proof authorization
4. Mismatch occurred: contract expected `Proof` authorization but transaction had `None_given`

### The Contract Methods

**`registerDID` (old method):**
```typescript
@method
async registerDID(
    userPublicKey: PublicKey,
    didDocumentHash: Field,
    witness: MerkleMapWitness,
    signature: Signature  // ← Requires explicit signature parameter
)
```
- Requires manual signature creation
- Signature must be passed as parameter
- Not compatible with wallet's automatic signature handling

**`registerDIDSimple` (new method):**
```typescript
@method
async registerDIDSimple(
    didDocumentHash: Field,
    witness: MerkleMapWitness
)
```
- Uses `this.sender.getAndRequireSignature()` internally
- Wallet automatically provides the signature authorization
- Designed specifically for wallet integration

## Solution

### Change Summary
Switch from `registerDID` to `registerDIDSimple` when using Auro Wallet.

### Before (BROKEN)
```typescript
// 1. Manually request signature from wallet
const signResult = await window.mina.signFields({
  message: [documentHash.toString()]
});

// 2. Parse signature
let signature = Signature.fromBase58(signResult.signature);

// 3. Build transaction with manual signature
const tx = await Mina.transaction(
  { sender: did, fee: 100_000_000 }, 
  async () => {
    await this.didRegistry.registerDID(
      did, 
      documentHash, 
      merkleWitness, 
      signature  // ← Explicit signature parameter
    );
  }
);

// 4. Send to wallet
const { hash } = await window.mina.sendTransaction({
  transaction: tx.toJSON(),
  feePayer: { fee: 0.1, memo: 'MinaID: DID Registration' }
});
```

### After (FIXED)
```typescript
// Build transaction using registerDIDSimple
const tx = await Mina.transaction(
  { sender: did, fee: 100_000_000 }, 
  async () => {
    await this.didRegistry.registerDIDSimple(
      documentHash,   // Only requires document hash
      merkleWitness   // and merkle witness
    );
    // No signature parameter - wallet handles it automatically
  }
);

// Send to wallet - wallet provides signature authorization
const { hash } = await window.mina.sendTransaction({
  transaction: tx.toJSON(),
  feePayer: { fee: 0.1, memo: 'MinaID: DID Registration' }
});
```

## Key Changes

1. **Removed manual signature creation:**
   - No more `window.mina.signFields()` call
   - No more signature parsing logic
   - Eliminates signature format compatibility issues

2. **Switched to `registerDIDSimple`:**
   - Method designed for wallet integration
   - Uses `sender.getAndRequireSignature()` internally
   - Wallet automatically provides correct authorization

3. **Simplified transaction flow:**
   - Build transaction → Send to wallet
   - Wallet proves + signs + submits
   - One-step process instead of multi-step

## Benefits

✅ **Eliminates authorization mismatch errors**
✅ **Simpler code** - 26 lines removed
✅ **Better wallet compatibility** - uses wallet's native signature handling
✅ **Clearer separation of concerns** - contract handles signature verification
✅ **Reduced error surface** - fewer manual steps

## Testing Checklist

- [ ] Refresh browser to clear old code
- [ ] Attempt DID registration with Auro Wallet
- [ ] Verify no "Authorization kind does not match" error
- [ ] Confirm wallet prompts for signature authorization
- [ ] Verify wallet proving process starts (2-3 minutes)
- [ ] Confirm transaction succeeds and appears on Minascan
- [ ] Verify DID is registered correctly on-chain

## Transaction Flow (After Fix)

```
1. User clicks "Register"
   ↓
2. Build transaction with registerDIDSimple
   ↓
3. Send unproved transaction to Auro Wallet
   ↓
4. Wallet adds Signature authorization (sender.getAndRequireSignature)
   ↓
5. Wallet proves transaction (2-3 minutes)
   ↓
6. User confirms in wallet
   ↓
7. Wallet submits to blockchain
   ↓
8. Transaction confirmed ✅
```

## Related Files

- `ui/lib/ContractInterface.ts` - Updated to use `registerDIDSimple`
- `contracts/src/DIDRegistry.ts` - Contains both methods
- `TRANSACTION_SIGNING_FIX.md` - Previous fix for "Invalid_proof" error

## Important Notes

1. **`registerDIDSimple` was added specifically for wallet integration**
   - Deployed contracts (Dec 8, 2025) include this method
   - Older deployments may not have this method

2. **Private key registration still uses `registerDID`**
   - When using private key directly, `registerDID` is still used
   - This path creates signature manually and proves client-side

3. **Both methods register DIDs identically**
   - Same on-chain state changes
   - Same events emitted
   - Only difference is how signature authorization is handled

## Verification

After deploying this fix, verify the contract has `registerDIDSimple`:

```bash
# Check contract methods
mina contract analyze B62qqfXbZPJAH3RBqbpKeQfUzWKw7JehiyHDhWCFZB8NLctRxoVPrTD
```

Expected output should include:
- `registerDID` - original method (4 parameters)
- `registerDIDSimple` - wallet-friendly method (2 parameters)
